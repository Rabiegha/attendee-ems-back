// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [citext]
}

model Organization {
  id         String   @id @default(uuid()) @db.Uuid
  name       String
  slug       String   @unique @db.Citext
  timezone   String?
  plan_id    String?  @db.Uuid  // Plan de l'organisation
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  // Relations
  plan                  Plan?          @relation(fields: [plan_id], references: [id], onDelete: SetNull)
  orgUsers              OrgUser[]      // Utilisateurs de cette organisation
  userRoles             UserRole[]     // Rôles assignés dans cette organisation
  platformUserAccess    PlatformUserOrgAccess[]  // Accès plateforme à cette org
  roles                 Role[]         // Rôles personnalisés de l'organisation
  invitations           Invitation[]
  attendees             Attendee[]
  orgActivitySectors    OrgActivitySector[]
  orgEventTypes         OrgEventType[]
  attendeeTypes         AttendeeType[]
  badgeTemplates        BadgeTemplate[]
  emailSenders          EmailSender[]
  events                Event[]
  tags                  Tag[]
  badges                Badge[]
  orgModuleOverrides    OrgModuleOverride[]  // Overrides de modules

  @@index([plan_id])
  @@map("organizations")
}

// ===== Users (global account) =====
model User {
  id            String   @id @default(uuid()) @db.Uuid
  email         String   @unique @db.Citext  // Email global unique
  password_hash String
  first_name    String?
  last_name     String?
  phone         String?
  company       String?
  job_title     String?
  country       String?
  metadata      Json?
  is_active     Boolean  @default(true)
  
  // Platform user marker
  is_platform   Boolean  @default(false)  // true = utilisateur plateforme (support, ops, etc.)
  
  // Reset password
  reset_token String?   @unique
  reset_token_expires_at DateTime?
  
  created_at    DateTime @default(now()) @map("created_at")
  updated_at    DateTime @updatedAt @map("updated_at")

  // Relations
  orgUsers               OrgUser[]           // Appartenance aux organisations
  userRoles              UserRole[]          // Rôles de l'utilisateur
  platformOrgAccess      PlatformUserOrgAccess[]  // Pour utilisateurs plateforme
  refreshTokens          RefreshToken[]
  sentInvitations        Invitation[]
  generatedBadges        Badge[]
  checkedInRegistrations Registration[] @relation("CheckedInBy")

  @@index([email])
  @@index([is_platform])
  @@map("users")
}

// ===== Org Users (user membership in organizations) =====
model OrgUser {
  id         String   @id @default(uuid()) @db.Uuid
  org_id     String   @db.Uuid
  user_id    String   @db.Uuid
  status     OrgUserStatus @default(active)  // active | invited | suspended
  is_default Boolean  @default(false)  // Organisation par défaut pour cet utilisateur
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [org_id], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, org_id])
  @@index([org_id])
  @@index([user_id])
  @@index([status])
  @@map("org_users")
}

enum OrgUserStatus {
  active
  invited
  suspended
}

// ===== User Roles (assignment of roles to users) =====
model UserRole {
  id         String   @id @default(uuid()) @db.Uuid
  user_id    String   @db.Uuid
  org_id     String?  @db.Uuid  // NULL pour les rôles plateforme
  role_id    String   @db.Uuid
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  // Relations
  user         User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [org_id], references: [id], onDelete: Cascade)
  role         Role          @relation(fields: [role_id], references: [id], onDelete: Cascade)

  @@unique([user_id, org_id, role_id])
  @@index([user_id])
  @@index([org_id])
  @@index([role_id])
  @@map("user_roles")
}

// ===== Platform User Org Access (platform users access to orgs) =====
model PlatformUserOrgAccess {
  id         String   @id @default(uuid()) @db.Uuid
  user_id    String   @db.Uuid  // User with is_platform = true
  org_id     String   @db.Uuid
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  // Relations
  user         User         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [org_id], references: [id], onDelete: Cascade)

  @@unique([user_id, org_id])
  @@index([user_id])
  @@index([org_id])
  @@map("platform_user_org_access")
}

// ===== Roles =====
model Role {
  id              String   @id @default(uuid()) @db.Uuid
  org_id          String?  @db.Uuid  // NULL = rôle plateforme, non-NULL = rôle organisation
  code            String
  name            String
  description     String?
  
  /rank/ RBAC avancé
              Int      @default(99)  // Hiérarchie: plus grand = plus puissant
  is_platform     Boolean  @default(false)  // true = rôle plateforme (support, root, etc.)
  is_root         Boolean  @default(false)  // true = God role (bypass total)
  role_type       RoleType @default(custom)  // Type logique du rôle
  is_locked       Boolean  @default(false)  // true = rôle clé non modifiable/supprimable
  managed_by_template Boolean @default(false)  // true = suit le PermissionRegistry
  
  // Plafond de scope pour ce rôle
  permission_ceiling_scope PermissionScope @default(any)  // Plafond: accès max autorisé pour ce rôle
  
  created_at      DateTime @default(now()) @map("created_at")
  updated_at      DateTime @updatedAt @map("updated_at")

  // Relations
  organization    Organization? @relation(fields: [org_id], references: [id], onDelete: Cascade)
  userRoles       UserRole[]
  invitations     Invitation[]
  rolePermissions RolePermission[]

  @@unique([org_id, code])  // Code unique par organisation (ou NULL pour plateforme)
  @@index([org_id])
  @@index([is_platform])
  @@index([is_root])
  @@index([role_type])
  @@index([managed_by_template])
  @@map("roles")
}

enum RoleType {
  tenant_admin      // Admin de l'organisation
  tenant_manager    // Manager de l'organisation
  tenant_staff      // Staff de l'organisation
  support_L1        // Support niveau 1
  support_L2        // Support niveau 2
  custom            // Rôle personnalisé
}

enum PermissionScope {
  any       // Accès total (all org for tenant, all tenants for platform)
  team      // Accès à l'équipe (tenant uniquement)
  assigned  // Accès aux ressources assignées
  own       // Accès uniquement à ses propres ressources
  none      // Pas d'accès
}

// ===== Permissions =====
model Permission {
  code        String   @id  // ex: "event.read" (clé unique)
  description String?
  resource    String   // ex: "event"
  action      String   // ex: "read", "create", "update", "delete"
  
  // Module et scopes
  module_key  String   // ex: "events", "attendees", "badges", "analytics"
  
  // Définit quels scopes sont autorisés pour cette permission
  // Le scope RÉEL est défini dans RolePermission.scope_limit
  allowed_scopes String[]  // ex: ["own", "team", "any"] - scopes autorisés
  
  // Scope maximal par défaut (utilisé lors de la création d'un rôle)
  default_scope_ceiling PermissionScope @default(any)  // Par défaut: accès à toute l'org (tenant) ou tous les tenants (platform)
  
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  // Relations
  rolePermissions RolePermission[]

  @@index([module_key])
  @@index([resource])
  @@map("permissions")
}

// ===== Role Permissions =====
model RolePermission {
  role_id          String   @db.Uuid
  permission_code  String   // permissions.code (au lieu de permission_id)
  
  // Scope effectif accordé pour cette permission dans ce rôle
  scope            PermissionScope @default(own)
  
  // Conditions avancées (optionnel, pour logiques complexes)
  conditions       Json?
  
  created_at       DateTime @default(now()) @map("created_at")
  updated_at       DateTime @updatedAt @map("updated_at")

  // Relations
  role         Role       @relation(fields: [role_id], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permission_code], references: [code], onDelete: Cascade)

  @@id([role_id, permission_code])
  @@index([role_id])
  @@index([permission_code])
  @@map("role_permissions")
}

model RefreshToken {
  id           String   @id @default(cuid())
  userId       String   @db.Uuid
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  jti          String   @unique              // ID logique du refresh (JWT ID)
  tokenHash    String                        // hash du refresh token (pas de stockage en clair)
  userAgent    String?                       // forensics / device management
  ip           String?                       // forensics
  createdAt    DateTime @default(now())
  expiresAt    DateTime
  revokedAt    DateTime?                     // null = actif
  replacedById String?                       // jti du nouveau token (pour détecter la réutilisation)

  @@index([userId])
  @@index([jti])
  @@index([expiresAt])
  @@map("refresh_tokens")

}

model Invitation {
  id               String            @id @default(uuid()) @db.Uuid
  email            String            @db.Citext
  token            String            @unique
  expires_at       DateTime
  org_id           String            @db.Uuid
  role_id          String            @db.Uuid
  invited_by       String            @db.Uuid  // user_id de l'inviteur
  status           InvitationStatus  @default(PENDING)
  created_at       DateTime          @default(now()) @map("created_at")
  updated_at       DateTime          @updatedAt @map("updated_at")

  // Relations
  organization     Organization      @relation(fields: [org_id], references: [id], onDelete: Cascade)
  role             Role              @relation(fields: [role_id], references: [id], onDelete: Restrict)
  invitedByUser    User              @relation(fields: [invited_by], references: [id], onDelete: Restrict)

  @@unique([email, org_id])
  @@index([org_id])
  @@index([role_id])
  @@index([invited_by])
  @@index([token])
  @@index([status])
  @@index([expires_at])
  @@map("invitations")
}

enum InvitationStatus {
  PENDING   // En attente de validation
  ACCEPTED  // Acceptée (compte créé)
  EXPIRED   // Expirée
  CANCELLED // Annulée par l'admin
}

model Attendee {
  id              String   @id @default(uuid()) @db.Uuid
  org_id          String   @db.Uuid
  default_type_id String?  @db.Uuid

  email           String   @db.Citext
  first_name      String?
  last_name       String?
  phone           String?
  company         String?
  job_title       String?
  country         String?
  metadata        Json?

  labels          String[] @db.Text
  notes           String?

  is_active       Boolean  @default(true)
  created_at      DateTime @default(now()) @map("created_at")
  updated_at      DateTime @updatedAt @map("updated_at")

  // Relations
  organization    Organization @relation(fields: [org_id], references: [id], onDelete: Cascade)
  revisions       AttendeeRevision[]
  registrations   Registration[]

  @@unique([org_id, email], name: "org_id_email")
  @@unique([id, org_id], name: "id_org_id")
  @@index([org_id])
  @@index([default_type_id])
  @@index([email])
  @@map("attendees")
}

model AttendeeRevision {
  id          String   @id @default(uuid()) @db.Uuid
  org_id      String   @db.Uuid
  attendee_id String   @db.Uuid
  change_type String   // 'import' | 'merge' | 'manual' | 'upsert'
  source      String?  // 'api' | 'ui' | 'csv:<file>'
  snapshot    Json
  changed_by  String?  @db.Uuid
  note        String?
  changed_at  DateTime @default(now())

  // Relations
  attendee    Attendee @relation(fields: [attendee_id], references: [id], onDelete: Cascade)

  @@index([org_id, attendee_id])
  @@index([attendee_id])
  @@map("attendee_revisions")
}

// ===== Activity Sectors =====
model OrgActivitySector {
  id              String   @id @default(uuid()) @db.Uuid
  org_id          String   @db.Uuid
  code            String
  name            String
  color_hex       String?
  text_color_hex  String?
  icon            String?
  parent_id       String?  @db.Uuid
  is_active       Boolean  @default(true)
  sort_order      Int      @default(0)
  created_at      DateTime @default(now()) @map("created_at")
  updated_at      DateTime @updatedAt @map("updated_at")

  // Relations
  organization    Organization @relation(fields: [org_id], references: [id], onDelete: Cascade)
  parent          OrgActivitySector? @relation("SectorHierarchy", fields: [parent_id, org_id], references: [id, org_id], onDelete: Restrict, onUpdate: NoAction)
  children        OrgActivitySector[] @relation("SectorHierarchy")
  events          Event[]

  @@unique([org_id, code])
  @@unique([id, org_id])
  @@index([org_id, parent_id, sort_order])
  @@map("org_activity_sectors")
}

// ===== Event Types =====
model OrgEventType {
  id              String   @id @default(uuid()) @db.Uuid
  org_id          String   @db.Uuid
  code            String
  name            String
  color_hex       String?
  text_color_hex  String?
  icon            String?
  is_active       Boolean  @default(true)
  sort_order      Int      @default(0)
  created_at      DateTime @default(now()) @map("created_at")
  updated_at      DateTime @updatedAt @map("updated_at")

  // Relations
  organization    Organization @relation(fields: [org_id], references: [id], onDelete: Cascade)
  events          Event[]

  @@unique([org_id, code])
  @@unique([id, org_id])
  @@index([org_id, sort_order])
  @@map("org_event_types")
}

// ===== Attendee Types =====
model AttendeeType {
  id              String   @id @default(uuid()) @db.Uuid
  org_id          String   @db.Uuid
  code            String
  name            String
  color_hex       String?
  text_color_hex  String?
  icon            String?
  is_active       Boolean  @default(true)
  sort_order      Int      @default(0)
  created_at      DateTime @default(now()) @map("created_at")
  updated_at      DateTime @updatedAt @map("updated_at")

  // Relations
  organization         Organization @relation(fields: [org_id], references: [id], onDelete: Cascade)
  eventAttendeeTypes   EventAttendeeType[]

  @@unique([org_id, code])
  @@unique([id, org_id])
  @@index([org_id, sort_order])
  @@index([org_id, name])
  @@map("attendee_types")
}

// ===== Badge Templates =====
model BadgeTemplate {
  id              String   @id @default(uuid()) @db.Uuid
  org_id          String   @db.Uuid
  event_id        String?  @db.Uuid // Optionnel : template global ou spécifique à un événement
  code            String
  name            String
  description     String?  @db.Text
  html            String?  @db.Text // Code HTML du template (généré par GrapesJS)
  css             String?  @db.Text // CSS du template (généré par GrapesJS)
  width           Int      @default(400) // Largeur du badge en pixels
  height          Int      @default(600) // Hauteur du badge en pixels
  template_data   Json?    // Données GrapesJS complètes (pour ré-éditer)
  variables       Json?    // Variables utilisées: ["attendee_name", "company", "qrcode", etc.]
  is_default      Boolean  @default(false) // Template par défaut de l'org
  is_active       Boolean  @default(true)
  usage_count     Int      @default(0) // Nombre de fois utilisé
  created_by      String?  @db.Uuid // ID de l'utilisateur qui a créé le template
  created_at      DateTime @default(now()) @map("created_at")
  updated_at      DateTime @updatedAt @map("updated_at")

  // Relations
  organization         Organization @relation(fields: [org_id], references: [id], onDelete: Cascade)
  event                Event?       @relation(fields: [event_id, org_id], references: [id, org_id], onDelete: Cascade, onUpdate: NoAction)
  eventSettings        EventSetting[]
  eventAttendeeTypeBadges EventAttendeeTypeBadge[]
  registrations        Registration[]
  badges               Badge[]

  @@unique([org_id, code])
  @@unique([id, org_id])
  @@index([org_id])
  @@index([org_id, event_id])
  @@index([org_id, is_default])
  @@map("badge_templates")
}

// ===== Email Senders =====
model EmailSender {
  id              String   @id @default(uuid()) @db.Uuid
  org_id          String   @db.Uuid
  from_name       String
  from_email      String   @db.Citext
  reply_to_email  String?  @db.Citext
  is_active       Boolean  @default(true)
  created_at      DateTime @default(now()) @map("created_at")
  updated_at      DateTime @updatedAt @map("updated_at")

  // Relations
  organization    Organization @relation(fields: [org_id], references: [id], onDelete: Cascade)
  emailSettings   EmailSetting[]

  @@unique([org_id, from_email])
  @@unique([id, org_id])
  @@index([org_id])
  @@map("email_senders")
}

// ===== Events =====
model Event {
  id                      String   @id @default(uuid()) @db.Uuid
  org_id                  String   @db.Uuid
  code                    String
  name                    String
  org_activity_sector_id  String?  @db.Uuid
  org_event_type_id       String?  @db.Uuid
  description             String?  @db.Text
  start_at                DateTime
  end_at                  DateTime
  timezone                String   @default("UTC")
  status                  EventStatus @default(draft)
  capacity                Int?
  location_type           LocationType @default(physical)
  address_formatted       String?
  address_street          String?
  address_city            String?
  address_region          String?
  address_postal_code     String?
  address_country         String?
  latitude                Decimal? @db.Decimal(9, 6)
  longitude               Decimal? @db.Decimal(9, 6)
  place_id                String?
  created_by              String?  @db.Uuid
  created_at              DateTime @default(now()) @map("created_at")
  updated_at              DateTime @updatedAt @map("updated_at")
  deleted_at              DateTime? @map("deleted_at")

  // Relations
  organization            Organization @relation(fields: [org_id], references: [id], onDelete: Cascade)
  activitySector          OrgActivitySector? @relation(fields: [org_activity_sector_id, org_id], references: [id, org_id], onDelete: SetNull, onUpdate: NoAction)
  eventType               OrgEventType? @relation(fields: [org_event_type_id, org_id], references: [id, org_id], onDelete: SetNull, onUpdate: NoAction)
  settings                EventSetting?
  emailSettings           EmailSetting?
  eventAttendeeTypes      EventAttendeeType[]
  registrations           Registration[]
  eventAccess             EventAccess[]
  subevents               Subevent[]
  partnerScans            PartnerScan[]
  eventTags               EventTag[]
  badgeTemplates          BadgeTemplate[] // Templates de badges pour cet événement
  badges                  Badge[]         // Badges générés pour cet événement

  @@unique([id, org_id])
  @@unique([org_id, code])
  @@index([org_id])
  @@index([org_id, start_at])
  @@index([org_id, status])
  @@index([org_id, org_activity_sector_id])
  @@index([org_id, org_event_type_id])
  @@map("events")
}

enum EventStatus {
  draft
  published
  registration_closed
  cancelled
  postponed
  archived
}

enum LocationType {
  physical
  online
  hybrid
}

enum AttendanceMode {
  onsite
  online
  hybrid
}

// ===== Event Settings (1:1 with Event) =====
model EventSetting {
  id                              String   @id @default(uuid()) @db.Uuid
  org_id                          String   @db.Uuid
  event_id                        String   @unique @db.Uuid
  website_url                     String?
  logo_asset_id                   String?
  attendance_mode                 AttendanceMode @default(onsite)
  registration_auto_approve       Boolean  @default(false)
  allow_checkin_out               Boolean  @default(true)
  has_event_reminder              Boolean  @default(false)
  badge_template_id               String?  @db.Uuid
  public_token                    String   @unique
  registration_fields             Json?
  submit_button_text              String?
  submit_button_color             String?
  show_title                      Boolean  @default(true)
  show_description                Boolean  @default(true)
  is_dark_mode                    Boolean  @default(false)
  auto_transition_to_active       Boolean  @default(true)
  auto_transition_to_completed    Boolean  @default(true)
  extra                           Json?
  created_at                      DateTime @default(now()) @map("created_at")
  updated_at                      DateTime @updatedAt @map("updated_at")

  // Relations
  event                           Event @relation(fields: [event_id, org_id], references: [id, org_id], onDelete: Cascade, onUpdate: NoAction)
  badgeTemplate                   BadgeTemplate? @relation(fields: [badge_template_id], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@unique([event_id, org_id])
  @@index([org_id, event_id])
  @@index([public_token])
  @@map("event_settings")
}

// ===== Email Settings (1:1 with Event) =====
model EmailSetting {
  id                          String   @id @default(uuid()) @db.Uuid
  org_id                      String   @db.Uuid
  event_id                    String   @unique @db.Uuid
  email_sender_id             String?  @db.Uuid
  
  // Email verification
  require_email_verification  Boolean  @default(false)
  
  // Confirmation email (envoyé à l'inscription)
  confirmation_enabled        Boolean  @default(false)
  confirmation_subject        String?
  confirmation_body           String?  @db.Text
  
  // Approval email (envoyé quand inscription approuvée)
  approval_enabled            Boolean  @default(false)
  approval_subject            String?
  approval_body               String?  @db.Text
  
  // Reminder email
  reminder_enabled            Boolean  @default(false)
  reminder_subject            String?
  reminder_body               String?  @db.Text
  reminder_hours_before       Int?
  
  created_at                  DateTime @default(now()) @map("created_at")
  updated_at                  DateTime @updatedAt @map("updated_at")

  // Relations
  event                       Event @relation(fields: [event_id, org_id], references: [id, org_id], onDelete: Cascade, onUpdate: NoAction)
  emailSender                 EmailSender? @relation(fields: [email_sender_id, org_id], references: [id, org_id], onDelete: SetNull, onUpdate: NoAction)

  @@unique([event_id, org_id])
  @@index([org_id, event_id])
  @@map("email_settings")
}

// ===== Event Attendee Types =====
model EventAttendeeType {
  id                String   @id @default(uuid()) @db.Uuid
  event_id          String   @db.Uuid
  org_id            String   @db.Uuid
  attendee_type_id  String   @db.Uuid
  capacity          Int?
  sort_order        Int      @default(0)
  created_at        DateTime @default(now()) @map("created_at")
  updated_at        DateTime @updatedAt @map("updated_at")

  // Relations
  event             Event @relation(fields: [event_id, org_id], references: [id, org_id], onDelete: Cascade, onUpdate: NoAction)
  attendeeType      AttendeeType @relation(fields: [attendee_type_id, org_id], references: [id, org_id], onDelete: Cascade, onUpdate: NoAction)
  registrations     Registration[]
  badges            EventAttendeeTypeBadge[]

  @@unique([id, event_id, org_id])
  @@unique([event_id, attendee_type_id])
  @@index([org_id, event_id, sort_order])
  @@map("event_attendee_types")
}

// ===== Event Attendee Type Badges =====
model EventAttendeeTypeBadge {
  event_attendee_type_id  String   @db.Uuid
  badge_template_id       String   @db.Uuid
  org_id                  String   @db.Uuid
  created_at              DateTime @default(now()) @map("created_at")

  // Relations
  eventAttendeeType       EventAttendeeType @relation(fields: [event_attendee_type_id], references: [id], onDelete: Cascade)
  badgeTemplate           BadgeTemplate @relation(fields: [badge_template_id, org_id], references: [id, org_id], onDelete: Cascade, onUpdate: NoAction)

  @@id([event_attendee_type_id, badge_template_id])
  @@index([org_id])
  @@map("event_attendee_type_badges")
}

// ===== Registrations =====
model Registration {
  id                      String   @id @default(uuid()) @db.Uuid
  org_id                  String   @db.Uuid
  event_id                String   @db.Uuid
  attendee_id             String   @db.Uuid
  status                  RegistrationStatus @default(awaiting)
  attendance_type         AttendanceMode @default(onsite)
  answers                 Json?
  event_attendee_type_id  String?  @db.Uuid
  badge_template_id       String?  @db.Uuid
  invited_at              DateTime?
  confirmed_at            DateTime?
  created_at              DateTime @default(now()) @map("created_at")
  updated_at              DateTime @updatedAt @map("updated_at")
  deleted_at              DateTime? @map("deleted_at")
  
  // Source de l'inscription (pour distinguer test/réel)
  source                  RegistrationSource @default(public_form) @map("source")
  
  // Snapshot des données de l'attendee au moment de l'inscription
  snapshot_first_name     String?  @map("snapshot_first_name")
  snapshot_last_name      String?  @map("snapshot_last_name")
  snapshot_email          String?  @map("snapshot_email")
  snapshot_phone          String?  @map("snapshot_phone")
  snapshot_company        String?  @map("snapshot_company")
  snapshot_job_title      String?  @map("snapshot_job_title")
  snapshot_country        String?  @map("snapshot_country")

  // Badge URLs (générés par le backend)
  badge_pdf_url           String?  @map("badge_pdf_url")
  badge_image_url         String?  @map("badge_image_url")

  // Check-in tracking
  checked_in_at           DateTime? @map("checked_in_at")
  checked_in_by           String?   @db.Uuid @map("checked_in_by")
  checkin_location        Json?     @map("checkin_location") // { lat, lng }
  
  // Comment from mobile app during registration
  comment                 String?   @db.Text @map("comment")

  // Relations
  event                   Event @relation(fields: [event_id, org_id], references: [id, org_id], onDelete: Cascade, onUpdate: NoAction)
  checkedInByUser         User? @relation("CheckedInBy", fields: [checked_in_by], references: [id], onDelete: SetNull)
  attendee                Attendee @relation(fields: [attendee_id, org_id], references: [id, org_id], onDelete: Cascade, onUpdate: NoAction)
  eventAttendeeType       EventAttendeeType? @relation(fields: [event_attendee_type_id], references: [id], onDelete: SetNull)
  badgeTemplate           BadgeTemplate? @relation(fields: [badge_template_id, org_id], references: [id, org_id], onDelete: SetNull, onUpdate: NoAction)
  badges                  Badge[]
  presenceVisits          PresenceVisit[]

  @@unique([event_id, attendee_id])
  @@unique([id, event_id, org_id])
  @@index([org_id, event_id, status])
  @@index([org_id, attendee_id])
  @@index([org_id, event_id, event_attendee_type_id])
  @@index([deleted_at])
  @@map("registrations")
}

enum RegistrationStatus {
  awaiting
  approved
  refused
  cancelled
}

enum RegistrationSource {
  public_form  // Inscription via formulaire public (vraie inscription)
  test_form    // Inscription via formulaire de test (fake)
  manual       // Créée manuellement par un admin
  import       // Importée via Excel
  mobile_app   // Créée depuis l'app mobile
}

// ===== Badges =====
enum BadgeStatus {
  pending      // En attente de génération
  generating   // En cours de génération
  completed    // Généré avec succès
  failed       // Échec de génération
}

model Badge {
  id                String       @id @default(uuid()) @db.Uuid
  org_id            String       @db.Uuid
  registration_id   String       @db.Uuid
  badge_template_id String       @db.Uuid
  event_id          String       @db.Uuid
  
  // URLs des fichiers générés
  pdf_url           String?      // URL du PDF sur Cloudflare R2
  image_url         String?      // URL de l'image preview (optionnel)
  
  // Données du badge (ancienne structure, gardée pour compatibilité)
  badge_data        Json?
  qr_code_url       String?
  
  // Métadonnées de génération
  generated_at      DateTime?    @map("generated_at")
  generated_by      String?      @db.Uuid
  
  // Snapshot du contenu au moment de la génération (pour audit trail)
  html_snapshot     String?      @db.Text
  css_snapshot      String?      @db.Text
  data_snapshot     Json?
  
  // Statut de génération
  status            BadgeStatus  @default(pending)
  error_message     String?      @db.Text
  
  // Suivi d'impression
  print_count       Int          @default(0)
  last_printed_at   DateTime?    @map("last_printed_at")
  
  created_at        DateTime     @default(now()) @map("created_at")
  updated_at        DateTime     @updatedAt @map("updated_at")

  // Relations
  registration      Registration  @relation(fields: [registration_id], references: [id], onDelete: Cascade)
  badgeTemplate     BadgeTemplate @relation(fields: [badge_template_id], references: [id], onDelete: Restrict, onUpdate: NoAction)
  organization      Organization  @relation(fields: [org_id], references: [id], onDelete: Cascade)
  event             Event         @relation(fields: [event_id, org_id], references: [id, org_id], onDelete: Cascade, onUpdate: NoAction)
  generatedByUser   User?         @relation(fields: [generated_by], references: [id], onDelete: SetNull)
  prints            BadgePrint[]

  @@unique([id, org_id])
  @@unique([registration_id]) // Un seul badge par registration
  @@index([org_id, registration_id])
  @@index([org_id, event_id])
  @@index([badge_template_id])
  @@index([status])
  @@index([generated_at])
  @@map("badges")
}

// ===== Badge Prints =====
model BadgePrint {
  id          String   @id @default(uuid()) @db.Uuid
  org_id      String   @db.Uuid
  badge_id    String   @db.Uuid
  printed_by  String?  @db.Uuid
  printed_at  DateTime @default(now())

  // Relations
  badge       Badge @relation(fields: [badge_id], references: [id], onDelete: Cascade)

  @@index([org_id, badge_id])
  @@index([printed_at])
  @@map("badge_prints")
}

// ===== Subevents (Phase 3) =====
model Subevent {
  id          String   @id @default(uuid()) @db.Uuid
  org_id      String   @db.Uuid
  event_id    String   @db.Uuid
  name        String
  start_at    DateTime
  end_at      DateTime
  location    String?
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  // Relations
  event       Event @relation(fields: [event_id, org_id], references: [id, org_id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([id, org_id])
  @@index([org_id, event_id])
  @@map("subevents")
}

// ===== Partner Scans (Phase 3) =====
model PartnerScan {
  id              String   @id @default(uuid()) @db.Uuid
  org_id          String   @db.Uuid
  event_id        String   @db.Uuid
  scanned_by      String   @db.Uuid
  attendee_data   Json
  scanned_at      DateTime @default(now())

  // Relations
  event           Event @relation(fields: [event_id, org_id], references: [id, org_id], onDelete: Cascade, onUpdate: NoAction)

  @@index([org_id, event_id])
  @@index([scanned_at])
  @@map("partner_scans")
}

// ===== Presence Visits (Phase 3 - check-in intervals) =====
model PresenceVisit {
  id              String   @id @default(uuid()) @db.Uuid
  org_id          String   @db.Uuid
  registration_id String   @db.Uuid
  checked_in_at   DateTime
  checked_out_at  DateTime?
  created_at      DateTime @default(now()) @map("created_at")
  updated_at      DateTime @updatedAt @map("updated_at")

  // Relations
  registration    Registration @relation(fields: [registration_id], references: [id], onDelete: Cascade)

  @@index([org_id, registration_id])
  @@index([checked_in_at])
  @@map("presence_visits")
}

// ===== Event Access (user assignment to events) =====
model EventAccess {
  id          String   @id @default(uuid()) @db.Uuid
  org_id      String   @db.Uuid
  event_id    String   @db.Uuid
  user_id     String   @db.Uuid
  reason      String?
  granted_by  String?  @db.Uuid
  expires_at  DateTime?
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  // Relations
  event       Event @relation(fields: [event_id, org_id], references: [id, org_id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([org_id, event_id, user_id])
  @@index([org_id, user_id])
  @@index([org_id, event_id])
  @@map("event_access")
}

// ===== Tags System =====

model Tag {
  id          String   @id @default(uuid()) @db.Uuid
  org_id      String   @db.Uuid
  name        String   // Nom du tag (ex: "Technologie", "Networking")
  color       String?  // Couleur optionnelle pour l'affichage (hex)
  usage_count Int      @default(0) // Nombre d'événements utilisant ce tag
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [org_id], references: [id], onDelete: Cascade)
  eventTags    EventTag[]

  @@unique([org_id, name]) // Un tag unique par nom dans une org
  @@index([org_id])
  @@index([org_id, usage_count(sort: Desc)]) // Pour trier par popularité
  @@map("tags")
}

model EventTag {
  event_id   String   @db.Uuid
  org_id     String   @db.Uuid
  tag_id     String   @db.Uuid
  created_at DateTime @default(now()) @map("created_at")

  // Relations
  event Event @relation(fields: [event_id, org_id], references: [id, org_id], onDelete: Cascade, onUpdate: NoAction)
  tag   Tag   @relation(fields: [tag_id], references: [id], onDelete: Cascade)

  @@id([event_id, tag_id])
  @@index([org_id, event_id])
  @@index([tag_id])
  @@map("event_tags")
}

// ===== Plans & Modules =====

model Plan {
  id              String   @id @default(uuid()) @db.Uuid
  code            String   @unique  // ex: "FREE", "PRO", "ENTERPRISE"
  name            String
  description     String?  @db.Text
  billing_period  String?  // ex: "monthly", "yearly"
  is_active       Boolean  @default(true)
  created_at      DateTime @default(now()) @map("created_at")
  updated_at      DateTime @updatedAt @map("updated_at")

  // Relations
  planModules     PlanModule[]
  organizations   Organization[]  // Orgs utilisant ce plan

  @@index([is_active])
  @@map("plans")
}

model Module {
  key         String   @id  // ex: "events", "attendees", "badges", "analytics"
  name        String
  description String?  @db.Text
  category    String?  // ex: "core", "premium", "advanced"
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  // Relations
  planModules     PlanModule[]
  orgModuleOverrides OrgModuleOverride[]

  @@index([category])
  @@map("modules")
}

model PlanModule {
  id                      String   @id @default(uuid()) @db.Uuid
  plan_id                 String   @db.Uuid
  module_key              String   // modules.key
  is_included_by_default  Boolean  @default(true)
  created_at              DateTime @default(now()) @map("created_at")
  updated_at              DateTime @updatedAt @map("updated_at")

  // Relations
  plan    Plan   @relation(fields: [plan_id], references: [id], onDelete: Cascade)
  module  Module @relation(fields: [module_key], references: [key], onDelete: Cascade)

  @@unique([plan_id, module_key])
  @@index([plan_id])
  @@index([module_key])
  @@map("plan_modules")
}

model OrgModuleOverride {
  id             String   @id @default(uuid()) @db.Uuid
  org_id         String   @db.Uuid
  module_key     String   // modules.key
  forced_status  ModuleOverrideStatus  // enabled | disabled
  created_at     DateTime @default(now()) @map("created_at")
  updated_at     DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [org_id], references: [id], onDelete: Cascade)
  module       Module       @relation(fields: [module_key], references: [key], onDelete: Cascade)

  @@unique([org_id, module_key])
  @@index([org_id])
  @@index([module_key])
  @@map("org_module_overrides")
}

enum ModuleOverrideStatus {
  enabled
  disabled
}
